{"version":3,"file":"AppUpdater.js","sourceRoot":"","sources":["../src/AppUpdater.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { randomBytes } from \"crypto\"\nimport { CancellationToken, Lazy, RequestHeaders } from \"electron-builder-http\"\nimport { BintrayOptions, GenericServerOptions, GithubOptions, PublishConfiguration, S3Options, s3Url } from \"electron-builder-http/out/publishOptions\"\nimport { UpdateInfo, VersionInfo } from \"electron-builder-http/out/updateInfo\"\nimport { EventEmitter } from \"events\"\nimport { outputFile, readFile } from \"fs-extra-p\"\nimport { safeLoad } from \"js-yaml\"\nimport * as path from \"path\"\nimport { eq as isVersionsEqual, gt as isVersionGreaterThan, prerelease as getVersionPreleaseComponents, valid as parseVersion } from \"semver\"\nimport \"source-map-support/register\"\nimport * as UUID from \"uuid-1345\"\nimport { BintrayProvider } from \"./BintrayProvider\"\nimport { ElectronHttpExecutor } from \"./electronHttpExecutor\"\nimport { GenericProvider } from \"./GenericProvider\"\nimport { GitHubProvider } from \"./GitHubProvider\"\nimport { FileInfo, Logger, Provider, UpdateCheckResult, UpdaterSignal } from \"./main\"\nimport { PrivateGitHubProvider } from \"./PrivateGitHubProvider\"\n\nexport abstract class AppUpdater extends EventEmitter {\n  /**\n   * Whether to automatically download an update when it is found.\n   */\n  autoDownload = true\n\n  /**\n   * *GitHub provider only.* Whether to allow update to pre-release versions. Defaults to `true` if application version contains prerelease components (e.g. `0.12.1-alpha.1`, here `alpha` is a prerelease component), otherwise `false`.\n   *\n   * If `true`, downgrade will be allowed (`allowDowngrade` will be set to `true`).\n   */\n  allowPrerelease = false\n\n  /**\n   * Whether to allow version downgrade (when a user from the beta channel wants to go back to the stable channel).\n   * @default false\n   */\n  allowDowngrade = false\n\n  /**\n   *  The request headers.\n   */\n  requestHeaders: RequestHeaders | null\n\n  protected _logger: Logger = console\n\n  /**\n   * The logger. You can pass [electron-log](https://github.com/megahertz/electron-log), [winston](https://github.com/winstonjs/winston) or another logger with the following interface: `{ info(), warn(), error() }`.\n   * Set it to `null` if you would like to disable a logging feature.\n   */\n  get logger(): Logger | null {\n    return this._logger\n  }\n\n  set logger(value: Logger | null) {\n    this._logger = value == null ? new NoOpLogger() : value\n  }\n\n  /**\n   * For type safety you can use signals, e.g. `autoUpdater.signals.updateDownloaded(() => {})` instead of `autoUpdater.on('update-available', () => {})`\n   */\n  readonly signals = new UpdaterSignal(this)\n\n  private _appUpdateConfigPath: string | null\n\n  /**\n   * test only\n   * @private\n   */\n  set updateConfigPath(value: string | null) {\n    this.clientPromise = null\n    this._appUpdateConfigPath = value\n    this.configOnDisk = new Lazy<any>(() => this.loadUpdateConfig())\n  }\n\n  protected updateAvailable = false\n\n  private clientPromise: Promise<Provider<any>> | null\n\n  protected readonly stagingUserIdPromise = new Lazy<string>(() => this.getOrCreateStagingUserId())\n\n  protected configOnDisk = new Lazy<any>(() => this.loadUpdateConfig())\n\n  private readonly untilAppReady: Promise<boolean>\n  private checkForUpdatesPromise: Promise<UpdateCheckResult> | null\n\n  protected readonly app: Electron.App\n\n  protected versionInfo: VersionInfo | null\n  private fileInfo: FileInfo | null\n\n  private currentVersion: string\n\n  protected readonly httpExecutor: ElectronHttpExecutor\n\n  constructor(options: PublishConfiguration | null | undefined, app?: any) {\n    super()\n\n    this.on(\"error\", (error: Error) => {\n      this._logger.error(`Error: ${error.stack || error.message}`)\n    })\n\n    if (app != null || (global as any).__test_app != null) {\n      this.app = app || (global as any).__test_app\n      this.untilAppReady = BluebirdPromise.resolve()\n    }\n    else {\n      this.app = require(\"electron\").app\n      this.httpExecutor = new ElectronHttpExecutor((authInfo, callback) => this.emit(\"login\", authInfo, callback))\n      this.untilAppReady = new BluebirdPromise(resolve => {\n        if (this.app.isReady()) {\n          this._logger.info(\"App is ready\")\n          resolve()\n        }\n        else {\n          this._logger.info(\"Wait for app ready\")\n          this.app.on(\"ready\", resolve)\n        }\n      })\n    }\n\n    const currentVersionString = this.app.getVersion()\n    this.currentVersion = parseVersion(currentVersionString)\n    if (this.currentVersion == null) {\n      throw new Error(`App version is not valid semver version: \"${currentVersionString}`)\n    }\n\n    this.allowPrerelease = hasPrereleaseComponents(this.currentVersion)\n\n    if (options != null) {\n      this.setFeedURL(options)\n    }\n  }\n\n  //noinspection JSMethodCanBeStatic,JSUnusedGlobalSymbols\n  getFeedURL(): string | null | undefined {\n    return \"Deprecated. Do not use it.\"\n  }\n\n  /**\n   * Configure update provider. If value is `string`, {@link module:electron-builder-http/out/publishOptions.GenericServerOptions} will be set with value as `url`.\n   * @param options If you want to override configuration in the `app-update.yml`.\n   */\n  setFeedURL(options: PublishConfiguration | GenericServerOptions | S3Options | BintrayOptions | GithubOptions | string) {\n    // https://github.com/electron-userland/electron-builder/issues/1105\n    let client: Provider<any>\n    if (typeof options === \"string\") {\n      client = new GenericProvider({provider: \"generic\", url: options}, this.httpExecutor)\n    }\n    else {\n      client = this.createClient(options)\n    }\n    this.clientPromise = BluebirdPromise.resolve(client)\n  }\n\n  /**\n   * Asks the server whether there is an update.\n   */\n  checkForUpdates(): Promise<UpdateCheckResult> {\n    let checkForUpdatesPromise = this.checkForUpdatesPromise\n    if (checkForUpdatesPromise != null) {\n      return checkForUpdatesPromise\n    }\n\n    checkForUpdatesPromise = this._checkForUpdates()\n    this.checkForUpdatesPromise = checkForUpdatesPromise\n    const nullizePromise = () => this.checkForUpdatesPromise = null\n    checkForUpdatesPromise\n      .then(nullizePromise)\n      .catch(nullizePromise)\n    return checkForUpdatesPromise\n  }\n\n  private async isStagingMatch(updateInfo: UpdateInfo): Promise<boolean> {\n    const rawStagingPercentage = updateInfo.stagingPercentage\n    let stagingPercentage = rawStagingPercentage\n    if (stagingPercentage == null) {\n      return true\n    }\n\n    stagingPercentage = parseInt(stagingPercentage as any, 10)\n    if (isNaN(stagingPercentage)) {\n      this._logger.warn(`Staging percentage is NaN: ${rawStagingPercentage}`)\n      return true\n    }\n\n    // convert from user 0-100 to internal 0-1\n    stagingPercentage = stagingPercentage / 100\n\n    const stagingUserId = await this.stagingUserIdPromise.value\n    const val = UUID.parse(stagingUserId).readUInt32BE(12)\n    const percentage = (val / 0xFFFFFFFF)\n    this._logger.info(`Staging percentage: ${stagingPercentage}, percentage: ${percentage}, user id: ${stagingUserId}`)\n    return percentage < stagingPercentage\n  }\n\n  private async _checkForUpdates(): Promise<UpdateCheckResult> {\n    try {\n      await this.untilAppReady\n      this._logger.info(\"Checking for update\")\n      this.emit(\"checking-for-update\")\n      return await this.doCheckForUpdates()\n    }\n    catch (e) {\n      this.emit(\"error\", e, `Cannot check for updates: ${(e.stack || e).toString()}`)\n      throw e\n    }\n  }\n\n  private async doCheckForUpdates(): Promise<UpdateCheckResult> {\n    if (this.clientPromise == null) {\n      this.clientPromise = this.configOnDisk.value.then(it => this.createClient(it))\n    }\n\n    const client = await this.clientPromise\n    const stagingUserId = await this.stagingUserIdPromise.value\n    client.setRequestHeaders({\"X-User-Staging-Id\": stagingUserId, ...this.requestHeaders})\n    const versionInfo = await client.getLatestVersion()\n\n    const latestVersion = parseVersion(versionInfo.version)\n    if (latestVersion == null) {\n      throw new Error(`Latest version (from update server) is not valid semver version: \"${latestVersion}`)\n    }\n\n    const isStagingMatch = await this.isStagingMatch(versionInfo)\n    if (!isStagingMatch || (this.allowDowngrade && !hasPrereleaseComponents(latestVersion) ? isVersionsEqual(latestVersion, this.currentVersion) : !isVersionGreaterThan(latestVersion, this.currentVersion))) {\n      this.updateAvailable = false\n      this._logger.info(`Update for version ${this.currentVersion} is not available (latest version: ${versionInfo.version}, downgrade is ${this.allowDowngrade ? \"allowed\" : \"disallowed\"}.`)\n      this.emit(\"update-not-available\", versionInfo)\n      return {\n        versionInfo,\n      }\n    }\n\n    const fileInfo = await client.getUpdateFile(versionInfo)\n\n    this.updateAvailable = true\n    this.versionInfo = versionInfo\n    this.fileInfo = fileInfo\n\n    this.onUpdateAvailable(versionInfo, fileInfo)\n\n    const cancellationToken = new CancellationToken()\n    //noinspection ES6MissingAwait\n    return {\n      versionInfo,\n      fileInfo,\n      cancellationToken,\n      downloadPromise: this.autoDownload ? this.downloadUpdate(cancellationToken) : null,\n    }\n  }\n\n  protected onUpdateAvailable(versionInfo: VersionInfo, fileInfo: FileInfo) {\n    this._logger.info(`Found version ${versionInfo.version} (url: ${fileInfo.url})`)\n    this.emit(\"update-available\", versionInfo)\n  }\n\n  /**\n   * Start downloading update manually. You can use this method if `autoDownload` option is set to `false`.\n   * @returns {Promise<string>} Path to downloaded file.\n   */\n  async downloadUpdate(cancellationToken: CancellationToken = new CancellationToken()): Promise<any> {\n    const versionInfo = this.versionInfo\n    const fileInfo = this.fileInfo\n    if (versionInfo == null || fileInfo == null) {\n      const message = \"Please check update first\"\n      const error = new Error(message)\n      this.emit(\"error\", error, message)\n      throw error\n    }\n\n    this._logger.info(`Downloading update from ${fileInfo.url}`)\n\n    try {\n      return await this.doDownloadUpdate(versionInfo, fileInfo, cancellationToken)\n    }\n    catch (e) {\n      this.dispatchError(e)\n      throw e\n    }\n  }\n\n  protected dispatchError(e: Error) {\n    this.emit(\"error\", e, (e.stack || e).toString())\n  }\n\n  protected async abstract doDownloadUpdate(versionInfo: VersionInfo, fileInfo: FileInfo, cancellationToken: CancellationToken): Promise<any>\n\n  /**\n   * Restarts the app and installs the update after it has been downloaded.\n   * It should only be called after `update-downloaded` has been emitted.\n   *\n   * **Note:** `autoUpdater.quitAndInstall()` will close all application windows first and only emit `before-quit` event on `app` after that.\n   * This is different from the normal quit event sequence.\n   *\n   * @param isSilent *windows-only* Runs the installer in silent mode.\n   * @param isForceRunAfter *windows-only* Run the app after finish even on silent install.\n   */\n  abstract quitAndInstall(isSilent?: boolean, isForceRunAfter?: boolean): void\n\n  private async loadUpdateConfig() {\n    if (this._appUpdateConfigPath == null) {\n      this._appUpdateConfigPath = require(\"electron-is-dev\") ? path.join(this.app.getAppPath(), \"dev-app-update.yml\") : path.join(process.resourcesPath!, \"app-update.yml\")\n    }\n    return safeLoad(await readFile(this._appUpdateConfigPath, \"utf-8\"))\n  }\n\n  /*** @private */\n  protected computeRequestHeaders(fileInfo: FileInfo): RequestHeaders | null {\n    const requestHeaders = this.requestHeaders\n    if (fileInfo.headers != null) {\n      return requestHeaders == null ? fileInfo.headers : {...fileInfo.headers, ...requestHeaders}\n    }\n    return requestHeaders\n  }\n\n  private createClient(data: string | PublishConfiguration) {\n    if (typeof data === \"string\") {\n      throw new Error(\"Please pass PublishConfiguration object\")\n    }\n\n    const provider = (data as PublishConfiguration).provider\n    switch (provider) {\n      case \"github\":\n        const githubOptions = data as GithubOptions\n        const token = (githubOptions.private ? process.env.GH_TOKEN : null) || githubOptions.token\n        if (token == null) {\n          return new GitHubProvider(githubOptions, this, this.httpExecutor)\n        }\n        else {\n          return new PrivateGitHubProvider(githubOptions, token, this.httpExecutor)\n        }\n\n      case \"s3\": {\n        const s3 = data as S3Options\n        return new GenericProvider({\n          provider: \"generic\",\n          url: s3Url(s3),\n          channel: s3.channel || \"\"\n        }, this.httpExecutor)\n      }\n\n      case \"generic\":\n        return new GenericProvider(data as GenericServerOptions, this.httpExecutor)\n\n      case \"bintray\":\n        return new BintrayProvider(data as BintrayOptions, this.httpExecutor)\n\n      default:\n        throw new Error(`Unsupported provider: ${provider}`)\n    }\n  }\n\n  private async getOrCreateStagingUserId(): Promise<string> {\n    const file = path.join(this.app.getPath(\"userData\"), \".updaterId\")\n    try {\n      const id = await readFile(file, \"utf-8\")\n      if (UUID.check(id)) {\n        return id\n      }\n      else {\n        this._logger.warn(`Staging user id file exists, but content was invalid: ${id}`)\n      }\n    }\n    catch (e) {\n      if (e.code !== \"ENOENT\") {\n        this._logger.warn(`Couldn't read staging user ID, creating a blank one: ${e}`)\n      }\n    }\n\n    const id = UUID.v5({name: randomBytes(4096), namespace: UUID.namespace.oid})\n    this._logger.info(`Generated new staging user ID: ${id}`)\n    try {\n      await outputFile(file, id)\n    }\n    catch (e) {\n      this._logger.warn(`Couldn't write out staging user ID: ${e}`)\n    }\n    return id\n  }\n}\n\nfunction hasPrereleaseComponents(version: string) {\n  const versionPrereleaseComponent = getVersionPreleaseComponents(version)\n  return versionPrereleaseComponent != null && versionPrereleaseComponent.length > 0\n}\n\n/** @private */\nexport class NoOpLogger implements Logger {\n  info(message?: any) {\n    // ignore\n  }\n\n  warn(message?: any) {\n    // ignore\n  }\n\n  error(message?: any) {\n    // ignore\n  }\n}"]}
